<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>斑块分割</title>
</head>

<body>
    <script src="../mock/plaque-slice-2.js"></script>
    <script src="../mock/plaque-slice-3.js"></script>
    <script src="../mock/plaque-slice.js"></script>
    <script>
        let huMap = bbb.split(',');
        let posMap = or.split(',');
        let tmp = tmpp.split(',');

        let plaque = '10874635,0,3,2,510,0,2,2,511,0,2,2,511,0,2,2,510,0,2,2,511,0,2,2,511,0,2,2,510,0,3,2,511,0,2,2,251896,0,3,2,510,0,2,2,510,0,2,2,511,0,2,2,510,0,3,2,510,0,3,2,510,0,3,2,510,0,3,2,510,0,2,2,510,0,4,2,510,0,3,2,511,0,1,2,499,0,4,2,509,0,5,2,508,0,4,2,509,0,3,2,509,0,3,2,510,0,3,2,510,0,3,2,510,0,3,2,510,0,3,2,251384,0,3,2,509,0,3,2,509,0,4,2,509,0,3,2,509,0,3,2,510,0,3,2,510,0,3,2,510,0,3,2,509,0,4,2,509,0,4,2,508,0,5,2,507,0,6,2,507,0,5,2,499,0,6,2,5,0,2,2,499,0,7,2,506,0,5,2,508,0,5,2,508,0,3,2,510,0,3,2,510,0,3,2,510,0,3,2,510,0,3,2,511,0,1,2,250360,0,3,2,509,0,3,2,509,0,4,2,508,0,4,2,508,0,4,2,508,0,4,2,509,0,4,2,508,0,5,2,508,0,5,2,507,0,6,2,507,0,6,2,506,0,7,2,504,0,8,2,503,0,10,2,499,0,13,2,499,0,8,2,4,0,1,2,500,0,6,2,508,0,4,2,508,0,4,2,510,0,3,2,509,0,4,2,510,0,3,2,511,0,1,2,250871,0,3,2,509,0,4,2,508,0,4,2,507,0,5,2,507,0,6,2,505,0,7,2,506,0,7,2,506,0,6,2,507,0,6,2,507,0,5,2,507,0,6,2,506,0,7,2,505,0,8,2,504,0,9,2,501,0,11,2,500,0,9,2,504,0,7,2,507,0,5,2,508,0,5,2,508,0,4,2,509,0,4,2,511,0,1,2,250869,0,4,2,508,0,5,2,507,0,5,2,506,0,6,2,505,0,8,2,504,0,8,2,503,0,3,2,2,3,4,2,502,0,3,2,4,3,4,2,500,0,6,2,2,3,4,2,501,0,12,2,500,0,4,2,1,0,7,2,502,0,2,2,2,0,7,2,506,0,7,2,504,0,9,2,502,0,10,2,503,0,8,2,505,0,6,2,508,0,3,2,511,0,1,2,252919,0,4,2,508,0,5,2,506,0,6,2,505,0,7,2,504,0,9,2,503,0,4,2,1,3,5,2,501,0,4,2,1,3,1,2,1,3,4,2,500,0,5,2,3,3,4,2,501,0,6,2,1,3,4,2,502,0,10,2,503,0,10,2,503,0,9,2,506,0,7,2,505,0,7,2,506,0,6,2,509,0,3,2,254453,0,3,2,508,0,5,2,506,0,7,2,504,0,8,2,504,0,9,2,503,0,9,2,503,0,9,2,504,0,9,2,504,0,8,2,505,0,7,2,506,0,6,2,509,0,3,2,256504,0,2,2,507,0,5,2,506,0,1,2,1,0,4,2,508,0,4,2,1824732,0,1,2,509,0,3,2,507,0,4,2,504,0,8,2,504,0,8,2,504,0,8,2,507,0,4,2,509,0,1,2,258563,0,1,2,508,0,5,2,501,0,10,2,502,0,9,2,502,0,9,2,503,0,7,2,506,0,4,2,259077,0,1,2,506,0,6,2,501,0,10,2,501,0,10,2,502,0,8,2,504,0,7,2,506,0,3,2,257534,0,1,2,510,0,3,2,509,0,3,2,509,0,3,2,1,0,1,2,1,0,1,2,1,0,3,2,500,0,10,2,502,0,9,2,503,0,7,2,506,0,4,2,257537,0,1,2,510,0,3,2,508,0,4,2,507,0,5,2,507,0,6,2,506,0,7,2,505,0,5,2,507,0,3,2,258560,0,2,2,510,0,3,2,508,0,4,2,508,0,5,2,506,0,7,2,260604,0,2,2,510,0,3,2,511,0,1,2,6859682,0,1,2,261118,0,3,2,507,0,5,2,505,0,6,2,505,0,3,2,508,0,2,2,509,0,1,2,259585,0,4,2,507,0,5,2,505,0,6,2,505,0,5,2,506,0,4,2,507,0,4,2,508,0,3,2,509,0,2,2,510,0,1,2,257542,0,2,2,507,0,5,2,505,0,7,2,504,0,6,2,505,0,3,2,508,0,3,2,508,0,3,2,508,0,3,2,509,0,3,2,509,0,3,2,509,0,2,2,256523,0,1,2,506,0,4,2,506,0,6,2,503,0,8,2,502,0,4,2,507,0,3,2,507,0,4,2,507,0,3,2,508,0,2,2,510,0,2,2,509,0,3,2,509,0,3,2,509,0,4,2,509,0,3,2,511,0,1,2,254987,0,6,2,502,0,6,2,504,0,7,2,503,0,8,2,1012,0,2,2,509,0,2,2,509,0,2,2,509,0,1,2,510,0,2,2,509,0,3,2,509,0,2,2,510,0,4,2,509,0,3,2,509,0,5,2,254985,0,9,2,500,0,8,2,502,0,3,2,2,0,2,2,505,0,2,2,1017,0,1,2,2553,0,2,2,508,0,3,2,509,0,4,2,508,0,5,2,508,0,7,2,506,0,7,2,506,0,6,2,253963,0,5,2,1,0,2,2,502,0,7,2,499,0,2,2,7,0,3,2,500,0,2,2,4081,0,2,2,510,0,2,2,511,0,1,2,511,0,1,2,6,0,1,2,507,0,6,2,506,0,6,2,505,0,4,2,253963,0,11,2,497,0,1,2,4,0,12,2,495,0,2,2,6,0,3,2,5604,0,1,2,511,0,1,2,8,0,3,2,508,0,4,2,506,0,4,2,507,0,4,2,253456,0,2,2,510,0,3,2,503,0,1,2,2,0,7,2,508,0,3,2,1,0,1,2,510,0,1,2,4066,0,1,2,511,0,1,2,1034,0,1,2,500,0,3,2,5,0,3,2,502,0,2,2,4,0,3,2,505,0,1,2,254486,0,2,2,511,0,2,2,6123,0,3,2,500,0,1,2,6,0,4,2,505,0,4,2,261121,0,3,2,507,0,4,2,506,0,3,2,506,0,5,2,259077,0,2,2,509,0,2,2,508,0,4,2,507,0,4,2,507,0,4,2,507,0,2,2,508,0,3,2,258564,0,3,2,508,0,3,2,508,0,4,2,507,0,4,2,507,0,5,2,506,0,5,2,507,0,2,2,509,0,2,2,257537,0,2,2,510,0,3,2,509,0,5,2,507,0,5,2,506,0,5,2,507,0,5,2,507,0,4,2,507,0,4,2,508,0,2,2,509,0,2,2,258048,0,3,2,509,0,4,2,508,0,4,2,507,0,5,2,508,0,4,2,508,0,3,2,508,0,4,2,508,0,2,2,509,0,2,2,258047,0,1,2,510,0,4,2,509,0,4,2,508,0,4,2,508,0,4,2,508,0,3,2,508,0,3,2,509,0,2,2,510,0,1,2,258560,0,2,2,509,0,3,2,509,0,3,2,509,0,3,2,509,0,3,2,509,0,3,2,509,0,2,2,1020,0,1,2,258561,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,509,0,1,2,511,0,1,2,510,0,1,2,259072,0,1,2,511,0,2,2,510,0,2,2,509,0,2,2,510,0,1,2,510,0,2,2,510,0,1,2,510,0,1,2,510,0,1,2,257538,0,1,2,511,0,1,2,511,0,1,2,511,0,1,2,510,0,2,2,510,0,2,2,509,0,2,2,510,0,2,2,509,0,2,2,510,0,1,2,501,0,1,2,257034,0,1,2,511,0,2,2,511,0,1,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,509,0,2,2,510,0,2,2,509,0,2,2,500,0,2,2,257545,0,1,2,511,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,509,0,2,2,510,0,2,2,509,0,2,2,500,0,2,2,8,0,1,2,502,0,2,2,257031,0,3,2,509,0,3,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,509,0,2,2,510,0,2,2,500,0,1,2,8,0,2,2,501,0,2,2,7,0,1,2,257023,0,2,2,510,0,3,2,510,0,2,2,510,0,3,2,509,0,3,2,509,0,3,2,509,0,2,2,510,0,2,2,509,0,2,2,510,0,2,2,510,0,1,2,257535,0,2,2,510,0,2,2,510,0,3,2,509,0,3,2,509,0,3,2,509,0,3,2,509,0,2,2,510,0,2,2,509,0,3,2,509,0,2,2,258047,0,1,2,511,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,1,2,510,0,2,2,258559,0,1,2,511,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,509,0,2,2,510,0,2,2,259583,0,1,2,511,0,1,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,510,0,1,2,260095,0,2,2,510,0,2,2,510,0,2,2,510,0,2,2,261119,0,1,2,511,0,1,2,510,0,1,2,510,0,1,2,7861753,0,2,2,510,0,3,2,510,0,1,2,260092,0,4,2,509,0,4,2,510,0,2,2,510,0,2,2,512,0,1,2,260090,0,6,2,509,0,3,2,510,0,2,2,511,0,1,2,260091,0,4,2,508,0,5,2,511,0,1,2,1831941,0,3,1,509,0,3,1,509,0,3,1,509,0,3,1,509,0,2,1,259583,0,2,1,509,0,4,1,507,0,5,1,507,0,5,1,507,0,5,1,508,0,3,1,509,0,2,1,259071,0,4,1,507,0,5,1,507,0,6,1,505,0,7,1,506,0,5,1,507,0,4,1,509,0,1,1,259072,0,4,1,507,0,6,1,505,0,7,1,505,0,7,1,505,0,6,1,507,0,5,1,509,0,1,1,259071,0,4,1,506,0,7,1,505,0,8,1,504,0,7,1,505,0,6,1,506,0,5,1,259583,0,4,1,506,0,7,1,504,0,7,1,505,0,6,1,506,0,5,1,259585,0,1,1,509,0,4,1,507,0,5,1,507,0,5,1,507,0,3,1,260607,0,3,1,508,0,4,1,25532307,0'.split(',')
        var rleDecode = nums => {
            //获取总长度
            var allLen = 0;
            for (var i = 0; i < nums.length; i += 2) {
                allLen += Number(nums[i]);
            }
            //创建缓冲区
            var buffer = new Uint8Array(new ArrayBuffer(allLen));
            var off = 0;
            //写入缓冲区
            for (var i = 0; i < nums.length; i += 2) {
                var len = Number(nums[i]);
                var val = Number(nums[i + 1]);
                buffer.fill(val, off, off + len);
                off += len;
            }
            return buffer;
        };
        let segVoxel = rleDecode(plaque)
        // tmp = tmp.split(',');
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        let imgData = new ImageData(512,573);
        for(let i = 0; i< imgData.data.length; i++) {
           if((i + 1) % 3 === 0  ) {
            imgData.data[i] =  0 // Number(tmp[i])
           } 
           if((i + 1) %2 == 0) {
            imgData.data[i] = 0

           }
           if((i + 1) % 1 == 0) {
            imgData.data[i] = 0
           }
           if((i + 1) % 4 === 0) {
            imgData.data[i] = 255
           }
        // else {
        //     imgData.data[i] = 10
        //    } 
           // = Number(tmp[i])
        } 
        console.log(imgData)
        let cprd = {
            w: 512,
            h: 512,
        }
        var colors = [
            [53, 204, 91],
            [77, 139, 255],
            [216, 109, 242],
            [255, 134, 64],
            [250, 63, 63]
        ];
        var limits = [-30, 30, 130, 350];
        var pixs = imgData.data;
        var idx = 0;
        var huIdx = 0;
        var layLen = cprd.w * cprd.h;
        canvas.height = 1200
        canvas.width = 1200
        console.log(posMap.length, huMap.length, pixs.length, segVoxel)
        for (var i = 0; i < pixs.length; i += 4, idx += 3, huIdx++) {
            var x = +(posMap[(+idx) + 0]);
            var y = cprd.h - +(posMap[+idx + 1]) - 1;
            var z = +posMap[+idx + 2];
            var offset = z * layLen + y * cprd.w + x;
            if (segVoxel[+offset] > 0) {
            console.log(segVoxel[offset])
                var colorIndex = 0;
                var hu = huMap[huIdx];
                for (var j = 0; j < limits.length; j++) {
                    if (hu > limits[j]) { colorIndex++; }
                }
                var color = colors[colorIndex];
                pixs[i + 0] = color[0];
                pixs[i + 1] = color[1];
                pixs[i + 2] = color[2];
            }
        }


        ctx.putImageData(imgData, 0, 0)
        document.body.append(canvas)
    </script>
</body>

</html>